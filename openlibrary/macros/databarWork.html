$def with (page, editions_page=False)

$if page.type.key == '/type/work' and page.edition_count == 1:
    $ edit_url = page.editions[0].key + '?m=edit'
$elif page.type.key in ["/type/work", "/type/edition", "/type/author"]:
    $ edit_url = page.url(suffix="/edit")
$else:
    $ edit_url = page.key + "?m=edit"

$ viewbook = "//%s/stream/XXX?ref=ol" % bookreader_host()
$ prices = page.key.startswith('/books/')

$ oclc_numbers = (page.oclc_numbers and page.oclc_numbers[0]) or ""
$ isbn_13 = page.get_isbn13()
$ isbn_10 = page.get_isbn10()

$ asin = None
$if page.get('identifiers'):
    $if page.identifiers.get('amazon'):
        $ asin = page.identifiers.amazon[0]

$if isbn_10 and not asin:
    $ asin = isbn_10

$code:
    def get_seed_info():
      if page.key.startswith("/subjects/"):
          seed = page.key.split("/")[-1]
          if seed.split(":")[0] not in ["place", "person", "time"]:
              seed = "subject:" + seed
          seed = seed.replace(",", "_").replace("__", "_")
          seed_type = "subject"
          title = page.name
      else:
          seed = {"key": page.key}
          if page.key.startswith("/authors/"):
              seed_type = "author"
              title = page.get('name', 'name missing')
          elif page.key.startswith("/works"):
              seed_type = "work"
              title = page.get("title", "untitled")
          else:
              seed_type = "edition"
              title = page.get("title", "untitled")
      return seed, seed_type, title
    
    def get_list_data(list, include_cover_url=True):
      d = storage({
          "name": list.name or "",
          "key": list.key,
          "active": list.has_seed(seed),
      })
      if include_cover_url:
          cover = list.get_cover() or list.get_default_cover()
          d['cover_url'] = cover and cover.url("S") or "/images/icons/avatar_book-sm.png"
      owner = list.get_owner()
      d['owner'] = storage(displayname=owner.displayname or "", key=owner.key)
      return d

    def get_user_lists():
      lists = ctx.user and ctx.user.get_lists(sort=True) or []
      return [get_list_data(list, include_cover_url=True) for list in lists]

$ seed, seed_type, title = get_seed_info()
$ user_lists = get_user_lists()

<div class="Tools">
  <div id="read">
    $if page.volumes:
      <h3 class="header">
        <span class="icon read"></span>
        <span class="head">Browse</span>
      </h3>
      $for v in page.volumes:
        $if v.ia_id != "-":
          <div class="panel">
            <p><a href="$viewbook.replace('XXX', v.ia_id)">View Volume $v.volume_number</a></p>
          </div>

    <div class="panel">
      <div class="btn-notice read-options" id="read-options">

        <div class="illustration edition-cover">
          $:render_template('covers/book_cover', page)
          $# Don't display add/change cover link for /books/ia:foo00bar pages
          $if not page.is_fake_record():
              $:render_template('covers/change', page, ".edition-cover .bookCover img")
        </div>

        $:macros.LoanStatus(page, ctx.user, editions_page=editions_page, block_name="read-options-panel")

        $# Added here instead of LoanStatus to avoid the js being bound to every item
        $# in a work's edition listing
        <script type="text/javascript">
          window.q.push(function() {
            \$('.return-book').submit(function(event) {
              if (!confirm("$_('Really return this book?')")) {
                event.preventDefault();
              }
            });
          });
        </script>
        
        $ work = (page.works and page.works[0]) if page.key.startswith("/books/") else page if page.key.startswith("/works/") else None
        $ username = ctx.user and ctx.user.key.split('/')[-1]
        $ users_work_read_status = work.get_users_read_status(username) if work and username else None
        $ edition = page if page.key.startswith("/books/") else None
        $ work_key = work and work.key
        $ edition_key = edition and edition.key 
        $ availability = page.availability if hasattr(page, 'availability') else {}
        $ availability_st = availability.get('status')
        $ ocaid = page.get('ocaid') or availability.get('identifier')
        $ lending_st = {}
        $ daisy = True

        $if editions_page and (availability.get('is_browseable', False) or availability_st == 'borrow_unavailable'):
          $ lending_st = get_cached_groundtruth_availability(ocaid)
        $ is_printdisabled = lending_st.get('is_printdisabled', False) or availability.get('is_printdisabled', False)

        $if ctx.user or not work_key:
          $:macros.Wanttoread(user_lists, work_key, edition_key, users_work_read_status, username, page.url(), False)

        $if ocaid and daisy:
          $:macros.daisy(page, url='/ia/%s/daisy' % ocaid, protected=is_printdisabled, block_name="read-options-panel")
        
        $if page.get('ocaid') and not page.is_access_restricted() and page.ia_metadata:
          $:macros.DownloadOptions(page)
      
      </div>
    </div>
  </div>

  <div class="panel">
    <div class="btn-notice">
      $# pages like /books/ia:foo00bar are fake records created from metadata API.
      $# Adding them to lists doesn't work. Disabling it to avoid any issues.
      $if "lists" in ctx.features and not page.is_fake_record():
        <div class="user-book-options">
          <div class="Tools tools-override">
            $:render_template("lists/widget", page, include_header=False)
          </div>
        </div>
    </div>
  </div>

  <div class="panel">
    <div class="btn-notice">    
      $if ctx.get('share_links'):
        $:macros.SocialShare(ctx.get('share_links'), request.home + page.key)
    </div>
  </div>


$ links = page.get_links()
$if links:
  <div id="external-links">
    <h3 class="header">
      <span class="icon download"></span>
      <span class="head">$_('External Links')</span>
    </h3>
    <div class="panel">
      <ul class="booklinks sansserif">
        $for link in links:
          <li><a href="$link.url">$link.title</a></li>
      </ul>
    </div>
  </div>
  <div class="clearfix"></div>

</div>
